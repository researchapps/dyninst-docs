<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples &mdash; Dyninst 12.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx-argparse.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Dyninst
          </a>
              <div class="version">
                12.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Dataflow API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dataflowAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataflowAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataflowAPI/index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dataflowAPI/index.html#api-reference">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">dynC API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dynC_API/index.html">DynC API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dynC_API/index.html#dync-language-description">DynC Language Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dynC_API/index.html#the-dyninst-domain">The Dyninst Domain</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Instruction API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../instructionAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instructionAPI/index.html#instructionapi-modules-and-abstractions">InstructionAPI Modules and Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instructionAPI/index.html#instructionapi-class-reference">InstructionAPI Class Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parse API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html#the-parsing-api">The Parsing API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html#extending-parseapi">Extending ParseAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parseAPI/index.html#defensive-mode-parsing">Defensive Mode Parsing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Patch API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#public-api-reference">Public API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#modification-api-reference">Modification API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#plugin-api-reference">Plugin API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#patchapi-for-dyninst-programmers">PatchAPI for Dyninst Programmers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Stackwalk</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../stackwalk/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stackwalk/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stackwalk/index.html#api-reference">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stackwalk/index.html#callback-interface-default-implementations">Callback Interface Default Implementations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Symtab API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#simple-examples">Simple Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#definitions-and-basic-types">Definitions and Basic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#namespace-symtabapi">Namespace SymtabAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#api-reference-symbol-table-interface">API Reference - Symbol Table Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#api-reference-line-number-interface">API Reference - Line Number Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#api-reference-type-interface">API Reference - Type Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symtabAPI/index.html#api-reference-dynamic-components">API Reference - Dynamic Components</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dyninst</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Examples</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/patchAPI/section/3_example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="examples">
<span id="sec-example"></span><h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline"></a></h1>
<p>To illustrate the ideas of PatchAPI, we present some simple code
examples that demonstrate how the API can be used.</p>
<div class="section" id="using-the-public-interface">
<h2>Using the public interface<a class="headerlink" href="#using-the-public-interface" title="Permalink to this headline"></a></h2>
<p>The basic flow of doing code patching is to first find some points in a
program, and then to insert, delete or update a piece of code at these
points.</p>
<div class="section" id="cfg-traversal">
<h3>CFG Traversal<a class="headerlink" href="#cfg-traversal" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ParseAPI</span><span class="p">::</span><span class="n">CodeObject</span><span class="o">*</span> <span class="n">co</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">PatchObject</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">PatchObject</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">code_base</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Find</span> <span class="nb">all</span> <span class="n">functions</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">object</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PatchFunction</span><span class="o">*&gt;</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">obj</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="p">(</span><span class="n">back_inserter</span><span class="p">(</span><span class="nb">all</span><span class="p">));</span>

<span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PatchFunction</span><span class="o">*&gt;</span><span class="p">::</span><span class="n">iterator</span> <span class="n">fi</span> <span class="o">=</span> <span class="nb">all</span><span class="o">.</span><span class="n">begin</span><span class="p">();</span>
     <span class="n">fi</span> <span class="o">!=</span> <span class="nb">all</span><span class="o">.</span><span class="n">end</span><span class="p">();</span> <span class="n">fi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Print</span> <span class="n">out</span> <span class="n">each</span> <span class="n">function</span><span class="s1">&#39;s name</span>
  <span class="n">PatchFunction</span><span class="o">*</span> <span class="n">func</span> <span class="o">=</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
  <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="n">const</span> <span class="n">PatchFunction</span><span class="p">::</span><span class="n">Blockset</span><span class="o">&amp;</span> <span class="n">blks</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">PatchFunction</span><span class="p">::</span><span class="n">BlockSet</span><span class="p">::</span><span class="n">iterator</span> <span class="n">bi</span> <span class="o">=</span> <span class="n">blks</span><span class="o">.</span><span class="n">begin</span><span class="p">();</span>
       <span class="n">bi</span> <span class="o">!=</span> <span class="n">blks</span><span class="o">.</span><span class="n">end</span><span class="p">();</span> <span class="n">bi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Print</span> <span class="n">out</span> <span class="n">each</span> <span class="n">block</span><span class="s1">&#39;s size</span>
    <span class="n">PatchBlock</span><span class="o">*</span> <span class="n">blk</span> <span class="o">=</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
    <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Block size:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">blk</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above code, we illustrate how to traverse CFG structures in
PatchAPI. First, we construct an instance of PatchObject using an
instance of ParseAPI’s CodeObject. Then, we traverse all functions in
that object, and print out each function’s name. For each function, we
also print out the size of each basic block.</p>
</div>
<div class="section" id="point-finding">
<span id="sec-example-pt"></span><h3>Point Finding<a class="headerlink" href="#point-finding" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PatchFunction</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">PatchBlock</span> <span class="o">*</span><span class="n">block</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">PatchEdge</span> <span class="o">*</span><span class="n">edge</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="n">PatchMgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">*&gt;</span> <span class="n">pts</span><span class="p">;</span>
<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">findPoints</span><span class="p">(</span><span class="n">Scope</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
                <span class="n">Point</span><span class="p">::</span><span class="n">FuncEntry</span> <span class="o">|</span>
                <span class="n">Point</span><span class="p">::</span><span class="n">PreCall</span> <span class="o">|</span>
                <span class="n">Point</span><span class="p">::</span><span class="n">FuncExit</span><span class="p">,</span>
                <span class="n">back_inserter</span><span class="p">(</span><span class="n">pts</span><span class="p">));</span>
<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">findPoints</span><span class="p">(</span><span class="n">Scope</span><span class="p">(</span><span class="n">block</span><span class="p">),</span>
                <span class="n">Point</span><span class="p">::</span><span class="n">BlockEntry</span><span class="p">,</span>
                <span class="n">back_inserter</span><span class="p">(</span><span class="n">pts</span><span class="p">));</span>
<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">findPoints</span><span class="p">(</span><span class="n">Scope</span><span class="p">(</span><span class="n">edge</span><span class="p">),</span>
                <span class="n">Point</span><span class="p">::</span><span class="n">EdgeDuring</span><span class="p">,</span>
                <span class="n">back_inserter</span><span class="p">(</span><span class="n">pts</span><span class="p">));</span>
</pre></div>
</div>
<p>The above code shows how to use the PatchMgr::findPoints method to find
some instrumentation points. There are three invocations of findPoints.
For the first invocation (Line 8), it finds points only within a
specific function <em>func</em>, and output the found points to a vector <em>pts</em>.
The result should include all points at this function’s entry, before
all function calls inside this function, and at the function’s exit.
Similarly, for the second invocation (Line 13), it finds points only
within a specific basic <em>block</em>, and the result should include the point
at the block entry. Finally, for the third invocation (Line 16), it
finds the point at a specific CFG <em>edge</em> that connects two basic blocks.</p>
</div>
<div class="section" id="code-patching">
<h3>Code Patching<a class="headerlink" href="#code-patching" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MySnippet</span><span class="p">::</span><span class="n">ptr</span> <span class="n">snippet</span> <span class="o">=</span> <span class="n">MySnippet</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">new</span> <span class="n">MySnippet</span><span class="p">);</span>

<span class="n">Patcher</span> <span class="n">patcher</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">*&gt;</span><span class="p">::</span><span class="n">iterator</span> <span class="nb">iter</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">begin</span><span class="p">();</span>
     <span class="nb">iter</span> <span class="o">!=</span> <span class="n">pts</span><span class="o">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="nb">iter</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Point</span><span class="o">*</span> <span class="n">pt</span> <span class="o">=</span> <span class="o">*</span><span class="nb">iter</span><span class="p">;</span>
  <span class="n">patcher</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PushBackCommand</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">snippet</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">patcher</span><span class="o">.</span><span class="n">commit</span><span class="p">();</span>
</pre></div>
</div>
<p>The above code is to insert the same code <em>snippet</em> to all points <em>pts</em>
found in Section&nbsp;<a class="reference external" href="#sec-example-pt">1.1.2</a>. We’ll explain the snippet
(Line 1) in the example in Section&nbsp;<a class="reference external" href="#sec-example-snip">1.2.2</a>. Each
point maintains a list of snippet instances, and the PushBackCommand is
to push a snippet instance to the end of that list. An instance of
Patcher is to represent a transaction of code patching. In this example,
all snippet insertions (or all PushBackCommands) are performed
atomically when the Patcher::commit method is invoked. That is, all
snippet insertions would succeed or all would fail.</p>
</div>
</div>
<div class="section" id="using-the-plugin-interface">
<h2>Using the plugin interface<a class="headerlink" href="#using-the-plugin-interface" title="Permalink to this headline"></a></h2>
<div class="section" id="address-space">
<h3>Address Space<a class="headerlink" href="#address-space" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAddrSpace</span> <span class="p">:</span> <span class="n">public</span> <span class="n">AddrSpace</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">virtual</span> <span class="n">Address</span> <span class="n">malloc</span><span class="p">(</span><span class="n">PatchObject</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">Address</span> <span class="n">near</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Address</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">...</span>
      <span class="o">//</span> <span class="n">do</span> <span class="n">memory</span> <span class="n">allocation</span> <span class="n">here</span>
      <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">virtual</span> <span class="nb">bool</span> <span class="n">write</span><span class="p">(</span><span class="n">PatchObject</span><span class="o">*</span> <span class="n">obj</span><span class="p">,</span> <span class="n">Address</span> <span class="n">to_addr</span><span class="p">,</span> <span class="n">Address</span> <span class="n">from_addr</span><span class="p">,</span>
                       <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">copy</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">address</span> <span class="n">from_addr</span> <span class="n">to</span> <span class="n">the</span> <span class="n">address</span> <span class="n">to_addr</span>
      <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The above code is to implement the address space plugin, in which, a set
of memory management methods should be specified, including malloc,
free, realloc, write and so forth. The instrumentation engine will
utilize these memory management methods during the code patching
process. For example, the instrumentation engine needs to <em>malloc</em> a
buffer in Mutatee’s address space, and then <em>write</em> the code snippet
into this buffer.</p>
</div>
<div class="section" id="snippet-representation">
<span id="sec-example-snip"></span><h3>Snippet Representation<a class="headerlink" href="#snippet-representation" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySnippet</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Snippet</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">virtual</span> <span class="nb">bool</span> <span class="n">generate</span><span class="p">(</span><span class="n">Point</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="n">Buffer</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Generate</span> <span class="ow">and</span> <span class="n">store</span> <span class="n">binary</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">Buffer</span> <span class="n">buf</span>
      <span class="k">return</span> <span class="n">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">MySnippet</span><span class="p">::</span><span class="n">ptr</span> <span class="n">snippet</span> <span class="o">=</span> <span class="n">MySnippet</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">new</span> <span class="n">MySnippet</span><span class="p">);</span>
</pre></div>
</div>
<p>The above code illustrates how to customize a user-defined snippet
<em>MySnippet</em> by implementing the “mini-compiler” in the <em>generate</em>
method, which will be used later in the instrumentation engine to
generate binary code.</p>
</div>
<div class="section" id="code-parsing">
<h3>Code Parsing<a class="headerlink" href="#code-parsing" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyFunction</span> <span class="p">:</span> <span class="n">public</span> <span class="n">PatchFunction</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">};</span>
<span class="k">class</span> <span class="nc">MyCFGMaker</span> <span class="p">:</span> <span class="n">public</span> <span class="n">CFGMaker</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">virtual</span> <span class="n">PatchFunction</span><span class="o">*</span> <span class="n">makeFunction</span><span class="p">(</span><span class="n">ParseAPI</span><span class="p">::</span><span class="n">Function</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">PatchObject</span><span class="o">*</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">new</span> <span class="n">MyFunction</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Programmers can augment PatchAPI’s CFG structures by annotating their
own data. In this case, a factory class should be built by inheriting
from the CFGMaker class, to create the augmented CFG structures. The
factory class will be used for CFG parsing.</p>
</div>
<div class="section" id="point-making">
<h3>Point Making<a class="headerlink" href="#point-making" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPoint</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Point</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">MyPoint</span><span class="p">(</span><span class="n">Point</span><span class="p">::</span><span class="n">Type</span> <span class="n">t</span><span class="p">,</span> <span class="n">PatchMgrPtr</span> <span class="n">m</span><span class="p">,</span> <span class="n">PatchFunction</span> <span class="o">*</span><span class="n">f</span><span class="p">);</span>
    <span class="o">...</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">MyPointMaker</span><span class="p">:</span> <span class="n">public</span> <span class="n">PointMaker</span> <span class="p">{</span>
  <span class="n">protected</span><span class="p">:</span>
    <span class="n">virtual</span> <span class="n">Point</span> <span class="o">*</span><span class="n">mkFuncPoint</span><span class="p">(</span><span class="n">Point</span><span class="p">::</span><span class="n">Type</span> <span class="n">t</span><span class="p">,</span> <span class="n">PatchMgrPtr</span> <span class="n">m</span><span class="p">,</span> <span class="n">PatchFunction</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">new</span> <span class="n">MyPoint</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>In the above example, the MyPoint class inherits from the Point class,
and the MyPointMaker class inherits from the PointMaker class. The
mkFuncPoint method in MyPointMaker simply returns a new instance of
MyPoint. The mkFuncPoint method will be invoked by
PatchMgr::findPoint(s).</p>
</div>
<div class="section" id="instrumentation-engine">
<h3>Instrumentation Engine<a class="headerlink" href="#instrumentation-engine" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyInstrumenter</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Instrumenter</span> <span class="p">{</span>
  <span class="n">public</span><span class="p">:</span>
    <span class="n">virtual</span> <span class="nb">bool</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Specify</span> <span class="n">how</span> <span class="n">to</span> <span class="n">install</span> <span class="n">instrumentation</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Programmers can customize the instrumentation engine by extending the
Instrumenter class, and implement the installation of instrumentation
inside the method <em>run()</em>.</p>
</div>
<div class="section" id="plugin-registration">
<h3>Plugin Registration<a class="headerlink" href="#plugin-registration" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MyCFGMakerPtr</span> <span class="n">cm</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">PatchObject</span><span class="o">*</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">PatchObject</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>

<span class="n">MyAddrSpacePtr</span> <span class="k">as</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">as</span><span class="o">-&gt;</span><span class="n">loadObject</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

<span class="n">MyInstrumenter</span> <span class="n">inst</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">PatchMgrPtr</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">PatchMgr</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="k">as</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>

<span class="n">MySnippet</span><span class="p">::</span><span class="n">ptr</span> <span class="n">snippet</span> <span class="o">=</span> <span class="n">MySnippet</span><span class="p">::</span><span class="n">create</span><span class="p">(</span><span class="n">new</span> <span class="n">MySnippet</span><span class="p">);</span>
</pre></div>
</div>
<p>The above code shows how to register the above four types of plugins. An
instance of the factory class for creating CFG structures is registered
to an PatchObject (Line 1 and 2), which is in turn loaded into an
instance of AddrSpace (Line 4 and 5). The AddrSpace (or its subclass
implemented by programmers) instance is passed to PatchMgr::create (Line
7 and 8), together with an instance of Instrumenter (or its subclass).
Finally, a snippet of custom snippet representation MySnippet is created
(Line 10). Therefore, all plugins are glued together in PatchAPI.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1996-2022, Barton P. Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>