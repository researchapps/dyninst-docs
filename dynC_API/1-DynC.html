<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DynC API &mdash; Dyninst 12.1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx-argparse.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Dyninst
          </a>
              <div class="version">
                12.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Dataflow API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dataflowAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataflowAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataflowAPI/index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dataflowAPI/index.html#api-reference">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">dynC API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">DynC API</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#dync-language-description">DynC Language Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#the-dyninst-domain">The Dyninst Domain</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Instruction API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../instructionAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../instructionAPI/index.html#instructionapi-modules-and-abstractions">InstructionAPI Modules and Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../instructionAPI/index.html#instructionapi-class-reference">InstructionAPI Class Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parse API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html#the-parsing-api">The Parsing API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html#extending-parseapi">Extending ParseAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parseAPI/index.html#defensive-mode-parsing">Defensive Mode Parsing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Patch API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#public-api-reference">Public API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#modification-api-reference">Modification API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#plugin-api-reference">Plugin API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patchAPI/index.html#patchapi-for-dyninst-programmers">PatchAPI for Dyninst Programmers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Stackwalk</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../stackwalk/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stackwalk/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stackwalk/index.html#api-reference">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stackwalk/index.html#callback-interface-default-implementations">Callback Interface Default Implementations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Symtab API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#abstractions">Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#simple-examples">Simple Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#definitions-and-basic-types">Definitions and Basic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#namespace-symtabapi">Namespace SymtabAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#api-reference-symbol-table-interface">API Reference - Symbol Table Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#api-reference-line-number-interface">API Reference - Line Number Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#api-reference-type-interface">API Reference - Type Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../symtabAPI/index.html#api-reference-dynamic-components">API Reference - Dynamic Components</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Dyninst</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>DynC API</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/dynC_API/1-DynC.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="dync-api">
<h1>DynC API<a class="headerlink" href="#dync-api" title="Permalink to this headline"></a></h1>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline"></a></h2>
<p>Dyninst is a powerful instrumentation tool, but specifying
instrumentation code (known as an Abstract Syntax Tree) in the language
can be cumbersome. DynC API answers these concerns, enabling a
programmer to easily and quickly build using a simple C-like language.
Other advantages to specifying using dynC include cleaner, more readable
mutator code, automatic variable handling, and runtime-compiled
snippets.</p>
<p>As a motivating example, the following implements a function tracer that
notifies the user when entering and exiting functions, and keeps track
of the number of times each function is called.</p>
<div class="section" id="dyninst-api">
<h3>Dyninst API<a class="headerlink" href="#dyninst-api" title="Permalink to this headline"></a></h3>
<p>When creating a function tracer using the Dyninst API, the programmer
must perform many discrete lookups and create many , which are then
combined and inserted into the mutatee.</p>
<p>Look up :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BPatch_function</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="n">printf_func</span><span class="p">;</span>
<span class="n">appImage</span><span class="o">-&gt;</span><span class="n">findFunction</span><span class="p">(</span><span class="s2">&quot;printf&quot;</span><span class="p">,</span> <span class="n">printf_func</span><span class="p">);</span>
<span class="n">BPatch_function</span> <span class="o">*</span><span class="n">BPF_printf</span> <span class="o">=</span> <span class="n">printf_func</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</pre></div>
</div>
<p>Create each pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BPatch_constExpr</span> <span class="n">entryPattern</span><span class="p">(</span><span class="s2">&quot;Entering </span><span class="si">%s</span><span class="s2">, called </span><span class="si">%d</span><span class="s2"> times.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="n">BPatch_constExpr</span> <span class="n">exitPattern</span><span class="p">(</span><span class="s2">&quot;Exiting </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>For each function, do the following:</strong></p>
<p>Create snippet vectors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BPatch_snippet</span> <span class="o">*&gt;</span> <span class="n">entrySnippetVect</span><span class="p">;</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BPatch_snippet</span> <span class="o">*&gt;</span> <span class="n">exitSnippetVect</span><span class="p">;</span>
</pre></div>
</div>
<p>Create the global variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">appProc</span><span class="o">-&gt;</span><span class="n">malloc</span><span class="p">(</span><span class="n">appImage</span><span class="o">-&gt;</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">),</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="p">(</span><span class="s2">&quot;intCounter&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Get the name of the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="n">fName</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="n">BPatch_constExpr</span> <span class="n">funcName</span><span class="p">(</span><span class="n">functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">(</span><span class="n">fName</span><span class="p">,</span> <span class="mi">128</span><span class="p">));</span>
</pre></div>
</div>
<p>Build the entry :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BPatch_snippet</span> <span class="o">*&gt;</span> <span class="n">entryArgs</span><span class="p">;</span>
<span class="n">entryArgs</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entryPattern</span><span class="p">);</span>
<span class="n">entryArgs</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">funcName</span><span class="p">);</span>
<span class="n">entryArgs</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">intCounter</span><span class="p">);</span>
</pre></div>
</div>
<p>Build the exit :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BPatch_snippet</span> <span class="o">*&gt;</span> <span class="n">exitArgs</span><span class="p">;</span>
<span class="n">exitArgs</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">exitPattern</span><span class="p">);</span>
<span class="n">exitArgs</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">funcName</span><span class="p">);</span>
</pre></div>
</div>
<p>Add to the snippet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entrySnippetVect</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">BPatch_functionCallExpr</span><span class="p">(</span><span class="o">*</span><span class="n">printf_func</span><span class="p">,</span> <span class="n">entryArgs</span><span class="p">));</span>
<span class="n">exitSnippetVect</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">BPatch_functionCallExpr</span><span class="p">(</span><span class="o">*</span><span class="n">printf_func</span><span class="p">,</span> <span class="n">exitArgs</span><span class="p">));</span>
</pre></div>
</div>
<p>Increment the counter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BPatch_arithExpr</span> <span class="n">addOne</span><span class="p">(</span><span class="n">BPatch_assign</span><span class="p">,</span> <span class="o">*</span><span class="n">intCounter</span><span class="p">,</span>
       <span class="n">BPatch_arithExpr</span><span class="p">(</span><span class="n">BPatch_plus</span><span class="p">,</span> <span class="o">*</span><span class="n">intCounter</span><span class="p">,</span> <span class="n">BPatch_constExpr</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
</pre></div>
</div>
<p>Add increment to the entry snippet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entrySnippetVect</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addOne</span><span class="p">);</span>
</pre></div>
</div>
<p>Insert the snippets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">appProc</span><span class="o">-&gt;</span><span class="n">insertSnippet</span><span class="p">(</span><span class="o">*</span><span class="n">entrySnippetVect</span><span class="p">,</span> <span class="n">functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">findPoint</span><span class="p">(</span><span class="n">BPatch_entry</span><span class="p">));</span>
<span class="n">appProc</span><span class="o">-&gt;</span><span class="n">insertSnippet</span><span class="p">(</span><span class="o">*</span><span class="n">exitSnippetVect</span><span class="p">,</span> <span class="n">functions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">findPoint</span><span class="p">(</span><span class="n">BPatch_exit</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="dync-api-1">
<span id="id1"></span><h3>DynC API<a class="headerlink" href="#dync-api-1" title="Permalink to this headline"></a></h3>
<p>A function tracer is much easier to build in DynC API, especially if
reading dynC code from file. Storing dynC code in external files not
only cleans up mutator code, but also allows the programmer to modify
snippets without recompiling.</p>
<p>In this example, the files and contain dynC code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// myEntryDynC.txt
static int intCounter;
printf(&quot;Entering %s, called %d times.\n&quot;, dyninst`function_name, intCounter++);
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// myExitDynC.txt
printf(&quot;Leaving %s.\n&quot;, dyninst`function_name);
</pre></div>
</div>
<p>The code to read, build, and insert the snippets would look something
like the following:</p>
<p>First open files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FILE</span> <span class="o">*</span><span class="n">entryFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s2">&quot;myEntryDynC.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
<span class="n">FILE</span> <span class="o">*</span><span class="n">exitFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s2">&quot;myExitDynC.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Next call DynC API with each function’s entry and exit points:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BPatch_snippet</span> <span class="o">*</span><span class="n">entrySnippet</span> <span class="o">=</span>
     <span class="n">dynC_API</span><span class="p">::</span><span class="n">createSnippet</span><span class="p">(</span><span class="n">entryFile</span><span class="p">,</span> <span class="n">entryPoint</span><span class="p">,</span> <span class="s2">&quot;entrySnippet&quot;</span><span class="p">);</span>
<span class="n">BPatch_snippet</span> <span class="o">*</span><span class="n">exitSnippet</span> <span class="o">=</span>
     <span class="n">dynC_API</span><span class="p">::</span><span class="n">createSnippet</span><span class="p">(</span><span class="n">exitFile</span><span class="p">,</span> <span class="n">exitPoint</span><span class="p">,</span> <span class="s2">&quot;exitSnippet&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally insert the snippets at each function’s entry and exit points:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">appProc</span><span class="o">-&gt;</span><span class="n">insertSnippet</span><span class="p">(</span><span class="o">*</span><span class="n">entrySnippet</span><span class="p">,</span> <span class="n">entryPoint</span><span class="p">);</span>
<span class="n">appProc</span><span class="o">-&gt;</span><span class="n">insertSnippet</span><span class="p">(</span><span class="o">*</span><span class="n">exitSnippet</span><span class="p">,</span> <span class="n">exitPoint</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="calling-dync-api">
<h2>Calling DynC API<a class="headerlink" href="#calling-dync-api" title="Permalink to this headline"></a></h2>
<p>All DynC functions reside in the namespace. The primary DynC API
function is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BPatch_Snippet</span> <span class="o">*</span><span class="n">createSnippet</span><span class="p">(</span><span class="o">&lt;</span><span class="n">dynC</span> <span class="n">code</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">location</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">);</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">where can be either a constant c-style string or a file descriptor and
can take the form of a or a . There is also an optional parameter to
name a snippet. A snippet name makes code and error reporting much
easier to read, and allows for the grouping of snippets (see section
<a class="reference external" href="#sec:varExplain">[sec:varExplain]</a>). If a snippet name is not
specified, the default name is used.</div>
</div>
<div class="centering container">
<table border="1" class="docutils" id="id2">
<caption><span class="caption-text">input options: dynC code</span><a class="headerlink" href="#id2" title="Permalink to this table"></a></caption>
<colgroup>
<col width="4%" />
<col width="96%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#160;</td>
<td>A C++ string containing dynC code.</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>A null terminated string containing dynC code</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>A standard C file descriptor. Facilitates reading dynC code from file.</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id3">
<caption><span class="caption-text">input options: location</span><a class="headerlink" href="#id3" title="Permalink to this table"></a></caption>
<colgroup>
<col width="4%" />
<col width="96%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#160;</td>
<td>Creates a snippet specific to a single point.</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>Creates a more flexible snippet specific to an address space.
See Section <a class="reference external" href="#sec:nopoint">1.3</a>.</td>
</tr>
</tbody>
</table>
</div>
<p>The location parameter is the point or address space in which the
snippet will be inserted. Inserting a snippet created for one location
into another can cause undefined behavior.</p>
</div>
<div class="section" id="creating-snippets-without-point-information">
<span id="sec-nopoint"></span><h2>Creating Snippets Without Point Information<a class="headerlink" href="#creating-snippets-without-point-information" title="Permalink to this headline"></a></h2>
<p>Creating a snippet without point information (i.e., calling with a )
results in a far more flexible snippet that may be inserted at any point
in the specified address space. There are, however, a few restrictions
on the types of operations that may be performed by a flexible snippet.
No local variables may be accessed, including parameters and return
values. Mutatee variables must be accessed through the domain.</p>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1996-2022, Barton P. Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>